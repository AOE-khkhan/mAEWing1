/*! \file ss_flutter_supression.c
 *	\brief 
 *
 *	\details  none yet
 *
 * \author University of Minnesota
 * \author Aerospace Engineering and Mechanics
 * \copyright Copyright 2017 Regents of the University of Minnesota. All rights reserved.
 *
 * $Id: ??? $
 */

#include "../globaldefs.h"
#include "../utils/matrix.h"
#include "ss_control_interface.h"

#define	 NCONT	2
#define	 NMEAS	3
#define	 NSTATE	11

static MATRIX SS_A, SS_B, SS_C, SS_D;
static MATRIX y, x, u;
static MATRIX tmpAx, tmpBy, tmpCx, tmpDy;
	
extern void init_ss01_control(void){
	/*++++++++++++++++++++++++++++++++++++++++++++++++
	 *matrix creation for control computation
	 *++++++++++++++++++++++++++++++++++++++++++++++++*/	
	SS_A 	= mat_creat(NSTATE, NSTATE, ZERO_MATRIX);	// State Transition Matrix
	SS_B 	= mat_creat(NSTATE, NMEAS, ZERO_MATRIX);	// Input Matrix
	SS_C 	= mat_creat(NCONT, NSTATE, ZERO_MATRIX);	// Output Matrix
	SS_D 	= mat_creat(NCONT, NMEAS, ZERO_MATRIX);		// Feedthrough Matrix
	
	tmpAx 	= mat_creat(NSTATE, 1, ZERO_MATRIX);	
	tmpBy 	= mat_creat(NSTATE, 1, ZERO_MATRIX);	
	tmpCx 	= mat_creat(NCONT, 1, ZERO_MATRIX);		
	tmpDy 	= mat_creat(NCONT, 1, ZERO_MATRIX);		
	
	x		= mat_creat(NSTATE, 1, ZERO_MATRIX);	// Controller State
	u		= mat_creat(NCONT, 1, ZERO_MATRIX);		// Controller Output
	y		= mat_creat(NMEAS, 1, ZERO_MATRIX);		// Controller Input

	/*START ASSEMBLY OF MATRICES */ 
	SS_A[0][0] = 0.9101162153889226;
	SS_A[1][0] = -0.2623230440982453;
	SS_A[2][0] = 0.1430231692488762;
	SS_A[3][0] = 0.0366526986635676;
	SS_A[4][0] = -0.0038889568565323;
	SS_A[5][0] = -0.0041773707659025;
	SS_A[6][0] = -0.0016360813992368;
	SS_A[7][0] = 0.0051476768507896;
	SS_A[8][0] = 0.0009345610821784;
	SS_A[9][0] = 0.0004740576319331;
	SS_A[10][0] = 0.0004796668044017;
	SS_A[0][1] = 0.2209668424208280;
	SS_A[1][1] = 0.8937725977950550;
	SS_A[2][1] = 0.1371138775170599;
	SS_A[3][1] = 0.1295551565766023;
	SS_A[4][1] = -0.0030059714224362;
	SS_A[5][1] = -0.0093761015565673;
	SS_A[6][1] = -0.0022655437463930;
	SS_A[7][1] = 0.0081007991835179;
	SS_A[8][1] = 0.0025347306686278;
	SS_A[9][1] = 0.0004760977764352;
	SS_A[10][1] = 0.0002141734679589;
	SS_A[0][2] = -0.1085733081593547;
	SS_A[1][2] = 0.1199077903488313;
	SS_A[2][2] = 0.7931574145274365;
	SS_A[3][2] = -0.3036115133355809;
	SS_A[4][2] = -0.0035705557577991;
	SS_A[5][2] = 0.0147210361196623;
	SS_A[6][2] = 0.0027540728526771;
	SS_A[7][2] = -0.0051155020560056;
	SS_A[8][2] = -0.0021621120175289;
	SS_A[9][2] = -0.0014776127288774;
	SS_A[10][2] = -0.0016370696862967;
	SS_A[0][3] = -0.0253972098366031;
	SS_A[1][3] = -0.1234273071191131;
	SS_A[2][3] = 0.2792679386835913;
	SS_A[3][3] = 0.4224294460348564;
	SS_A[4][3] = 0.1892607017110553;
	SS_A[5][3] = 0.0919600623176240;
	SS_A[6][3] = 0.0484245778735940;
	SS_A[7][3] = -0.2056123194044095;
	SS_A[8][3] = -0.0550735919013160;
	SS_A[9][3] = 0.0064944676317717;
	SS_A[10][3] = 0.0164874701359997;
	SS_A[0][4] = 0.0060566146703223;
	SS_A[1][4] = -0.0028635327262755;
	SS_A[2][4] = -0.0005032828787155;
	SS_A[3][4] = -0.1700134936815826;
	SS_A[4][4] = 0.8928319687845741;
	SS_A[5][4] = -0.3264285190040589;
	SS_A[6][4] = -0.0227780634687009;
	SS_A[7][4] = 0.1066734237409051;
	SS_A[8][4] = 0.0536015752419039;
	SS_A[9][4] = -0.0043156704136632;
	SS_A[10][4] = -0.0126663370370227;
	SS_A[0][5] = 0.0088809873537464;
	SS_A[1][5] = 0.0064221568340033;
	SS_A[2][5] = -0.0021630519742185;
	SS_A[3][5] = 0.0646907930295211;
	SS_A[4][5] = 0.2969254832858310;
	SS_A[5][5] = 0.8967918284041019;
	SS_A[6][5] = -0.0776945286453976;
	SS_A[7][5] = 0.1755387002529077;
	SS_A[8][5] = 0.0454060898346518;
	SS_A[9][5] = -0.0140253851229420;
	SS_A[10][5] = -0.0212020125393506;
	SS_A[0][6] = -0.0046429935595132;
	SS_A[1][6] = 0.0011104489705709;
	SS_A[2][6] = -0.0077848349540164;
	SS_A[3][6] = -0.0166323073092742;
	SS_A[4][6] = 0.0172555888772281;
	SS_A[5][6] = 0.0575109003561192;
	SS_A[6][6] = 0.9766111500965298;
	SS_A[7][6] = 0.1711316095319188;
	SS_A[8][6] = 0.0139026297314078;
	SS_A[9][6] = 0.0090904874733492;
	SS_A[10][6] = 0.0076896376761119;
	SS_A[0][7] = -0.0237619363927431;
	SS_A[1][7] = 0.0062046796433489;
	SS_A[2][7] = -0.0286849392034693;
	SS_A[3][7] = 0.0684884948116693;
	SS_A[4][7] = 0.0527183258055791;
	SS_A[5][7] = -0.0140279506589786;
	SS_A[6][7] = -0.1460495932646322;
	SS_A[7][7] = 0.6258390842253194;
	SS_A[8][7] = -0.3038074425609229;
	SS_A[9][7] = 0.0733389816442034;
	SS_A[10][7] = 0.0927267251004975;
	SS_A[0][8] = -0.0082508041117985;
	SS_A[1][8] = -0.0023071681793621;
	SS_A[2][8] = -0.0085549653659037;
	SS_A[3][8] = -0.0868382970614166;
	SS_A[4][8] = -0.0334778748642603;
	SS_A[5][8] = 0.0821446785445939;
	SS_A[6][8] = -0.0467977267689876;
	SS_A[7][8] = -0.0237701003617494;
	SS_A[8][8] = 0.7976889318206882;
	SS_A[9][8] = 0.1603917219641225;
	SS_A[10][8] = 0.0936050267513458;
	SS_A[0][9] = -0.0005087112056630;
	SS_A[1][9] = 0.0004150692348995;
	SS_A[2][9] = -0.0023294970742223;
	SS_A[3][9] = -0.0133994010364397;
	SS_A[4][9] = 0.0054721164991065;
	SS_A[5][9] = 0.0196052634546964;
	SS_A[6][9] = 0.0053398846251328;
	SS_A[7][9] = -0.0846277777514179;
	SS_A[8][9] = -0.1530039607964935;
	SS_A[9][9] = 0.9481867699556535;
	SS_A[10][9] = -0.1112211620376037;
	SS_A[0][10] = -0.0014525713547457;
	SS_A[1][10] = 0.0020806678039603;
	SS_A[2][10] = -0.0028358148806250;
	SS_A[3][10] = 0.0384683614413947;
	SS_A[4][10] = 0.0310697801234407;
	SS_A[5][10] = -0.0177751410891504;
	SS_A[6][10] = 0.0123786291967535;
	SS_A[7][10] = -0.0821277793508736;
	SS_A[8][10] = 0.0745343043724512;
	SS_A[9][10] = 0.0230957426287204;
	SS_A[10][10] = 0.5239353089912124;

	SS_B[0][0] = -0.0042177614455815;
	SS_B[1][0] = -0.0031568475604860;
	SS_B[2][0] = 0.0038170645075112;
	SS_B[3][0] = 0.0022689384995106;
	SS_B[4][0] = -0.0001537978350541;
	SS_B[5][0] = -0.0002174653958916;
	SS_B[6][0] = -0.0000735012657537;
	SS_B[7][0] = 0.0002555369627794;
	SS_B[8][0] = 0.0000710472020956;
	SS_B[9][0] = 0.0000111256640467;
	SS_B[10][0] = 0.0000042278050311;
	SS_B[0][1] = 0.0000083007504556;
	SS_B[1][1] = -0.0000049562968270;
	SS_B[2][1] = 0.0000009640714875;
	SS_B[3][1] = 0.0000048111678087;
	SS_B[4][1] = -0.0000016566107656;
	SS_B[5][1] = -0.0000012121705071;
	SS_B[6][1] = 0.0000087053439694;
	SS_B[7][1] = -0.0000079387805251;
	SS_B[8][1] = -0.0000255525367703;
	SS_B[9][1] = -0.0000066139462356;
	SS_B[10][1] = -0.0000141842188919;
	SS_B[0][2] = -0.0000033513986653;
	SS_B[1][2] = 0.0000312061603070;
	SS_B[2][2] = -0.0000270163955721;
	SS_B[3][2] = -0.0000207679887783;
	SS_B[4][2] = -0.0000076989463887;
	SS_B[5][2] = 0.0000039892687160;
	SS_B[6][2] = -0.0000278083569244;
	SS_B[7][2] = 0.0000317420899608;
	SS_B[8][2] = 0.0000472604574339;
	SS_B[9][2] = 0.0000247603107676;
	SS_B[10][2] = 0.0000385209524029;

	SS_C[0][0] = -0.5130208321320656;
	SS_C[1][0] = -0.1858018905061360;
	SS_C[0][1] = 0.3674119284087852;
	SS_C[1][1] = -0.4120596776981831;
	SS_C[0][2] = -0.5267580226078330;
	SS_C[1][2] = 0.2660145601946021;
	SS_C[0][3] = 0.3843165173929192;
	SS_C[1][3] = -0.6080528172071092;
	SS_C[0][4] = 0.0885131426871652;
	SS_C[1][4] = -0.0327048861057758;
	SS_C[0][5] = 0.0073917004802315;
	SS_C[1][5] = 0.1132775725182091;
	SS_C[0][6] = -0.0047515221471859;
	SS_C[1][6] = -0.0194632702326465;
	SS_C[0][7] = -0.1806341461419177;
	SS_C[1][7] = -0.1007266804481495;
	SS_C[0][8] = -0.0081484377152340;
	SS_C[1][8] = -0.1073543635666225;
	SS_C[0][9] = -0.0134106199469380;
	SS_C[1][9] = -0.0227500264181254;
	SS_C[0][10] = -0.0478904651807054;
	SS_C[1][10] = 0.0297461533219216;

	SS_D[0][0] = -0.0000000000000000;
	SS_D[1][0] = -0.0000000000000000;
	SS_D[0][1] = -0.0000000000073620;
	SS_D[1][1] = -0.0000000000431047;
	SS_D[0][2] = 0.0000000000075093;
	SS_D[1][2] = -0.0000000003356937;

	/*END ASSEMBLY OF MATRICES */  
}

// Main get_control function
extern void get_ss01_control(double* measurement, double* control_signal) {
	
	y[0][0] = measurement[0];		// q
	y[1][0] = measurement[1];		// az
	y[2][0] = measurement[2];		// accel
	
	// Output Calculation
	tmpCx = mat_mul(SS_C, x, tmpCx);
	tmpDy = mat_mul(SS_D, y, tmpDy);
	u = mat_add(tmpCx, tmpDy, u);
	
	// State Update
	tmpAx = mat_mul(SS_A, x, tmpAx);
	tmpBy = mat_mul(SS_B, y, tmpBy);
	x = mat_add(tmpAx, tmpBy, x);
	
	control_signal[0]   = u[0][0];	// L1R1 symmetric [rad]
	control_signal[1]   = u[1][0];	// L4R4 symmetric [rad]
}

extern void close_ss01_control(void){
	//free memory space
	mat_free(SS_A);
	mat_free(SS_B);
	mat_free(SS_C);
	mat_free(SS_D);
	mat_free(tmpAx);
	mat_free(tmpBy);
	mat_free(tmpCx);
	mat_free(tmpDy);
	mat_free(x);
	mat_free(u);
	mat_free(y);
}


// Reset parameters to initial values
extern void reset_ss01_control(void){
	x = mat_scalMul(x, 0.0, x);
}
