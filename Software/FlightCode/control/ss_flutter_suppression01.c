/*! \file ss_flutter_supression.c
 *	\brief 
 *
 *	\details  none yet
 *
 * \author University of Minnesota
 * \author Aerospace Engineering and Mechanics
 * \copyright Copyright 2017 Regents of the University of Minnesota. All rights reserved.
 *
 * $Id: ??? $
 */

#include "../globaldefs.h"
#include "ss_control_interface.h"
#include "../utils/matrix.h"

#define	 NCONT	2
#define	 NMEAS	3
#define	 NSTATE	11

static MATRIX SS_A, SS_B, SS_C, SS_D;
static MATRIX y, x, u;
static MATRIX tmpAx, tmpBy, tmpCx, tmpDy;
	
extern void init_ss_control(void){
	/*++++++++++++++++++++++++++++++++++++++++++++++++
	 *matrix creation for control computation
	 *++++++++++++++++++++++++++++++++++++++++++++++++*/	
	SS_A 	= mat_creat(NSTATE, NSTATE, ZERO_MATRIX);	// State Transition Matrix
	SS_B 	= mat_creat(NSTATE, NMEAS, ZERO_MATRIX);	// Input Matrix
	SS_C 	= mat_creat(NCONT, NSTATE, ZERO_MATRIX);	// Output Matrix
	SS_D 	= mat_creat(NCONT, NMEAS, ZERO_MATRIX);		// Feedthrough Matrix
	
	tmpAx 	= mat_creat(NSTATE, 1, ZERO_MATRIX);	
	tmpBy 	= mat_creat(NSTATE, 1, ZERO_MATRIX);	
	tmpCx 	= mat_creat(NCONT, 1, ZERO_MATRIX);		
	tmpDy 	= mat_creat(NCONT, 1, ZERO_MATRIX);		
	
	x		= mat_creat(NSTATE, 1, ZERO_MATRIX);	// Controller State
	u		= mat_creat(NCONT, 1, ZERO_MATRIX);		// Controller Output
	y		= mat_creat(NMEAS, 1, ZERO_MATRIX);		// Controller Input

/*START ASSEMBLY OF MATRICES */ 

SS_A[0][0] = -7.2306817507711489;
SS_A[1][0] = -42.2187271347628300;
SS_A[2][0] = 23.9449590612696600;
SS_A[3][0] = 18.8356350951270560;
SS_A[4][0] = -2.5792625163554850;
SS_A[5][0] = -3.0496690843153531;
SS_A[6][0] = -0.4288620844455272;
SS_A[7][0] = 5.5494359745689295;
SS_A[8][0] = 2.7415574060818222;
SS_A[9][0] = -0.6516966050161074;
SS_A[10][0] = -1.3386676033540796;
SS_A[0][1] = 36.9595055800081410;
SS_A[1][1] = -9.9142134601791874;
SS_A[2][1] = 14.8633263166888870;
SS_A[3][1] = 30.9609473033699200;
SS_A[4][1] = -3.2355460693317024;
SS_A[5][1] = -4.2092782079981337;
SS_A[6][1] = -0.5631811676664315;
SS_A[7][1] = 7.3388881104136381;
SS_A[8][1] = 3.6901089703197010;
SS_A[9][1] = -0.8958764848033729;
SS_A[10][1] = -1.8477946934812393;
SS_A[0][2] = -20.4544634464542800;
SS_A[1][2] = 11.6342911781564720;
SS_A[2][2] = -20.8172618160827020;
SS_A[3][2] = -70.8065378505706210;
SS_A[4][2] = 6.0662600460335669;
SS_A[5][2] = 8.3124208506942452;
SS_A[6][2] = 1.1215306032843235;
SS_A[7][2] = -14.1876383999654030;
SS_A[8][2] = -7.2711760574453717;
SS_A[9][2] = 1.7593676418372381;
SS_A[10][2] = 3.6201070172866276;
SS_A[0][3] = 1.7383950399034409;
SS_A[1][3] = -30.6620179590258740;
SS_A[2][3] = 65.2936022068370080;
SS_A[3][3] = -100.6886496441349100;
SS_A[4][3] = 36.6407900086760140;
SS_A[5][3] = 26.9178138339755510;
SS_A[6][3] = 5.3083110354472245;
SS_A[7][3] = -58.8683023332522950;
SS_A[8][3] = -27.0756360120131920;
SS_A[9][3] = 7.1107574917234917;
SS_A[10][3] = 14.2996523996453920;
SS_A[0][4] = 2.0121038237278577;
SS_A[1][4] = -2.8218566251382606;
SS_A[2][4] = 6.0267671876660378;
SS_A[3][4] = -32.5352114037734670;
SS_A[4][4] = -5.4936423948849633;
SS_A[5][4] = -50.7889166425059670;
SS_A[6][4] = -2.5460385482319579;
SS_A[7][4] = 21.1484496711516460;
SS_A[8][4] = 13.2940492823130820;
SS_A[9][4] = -2.9405179821167700;
SS_A[10][4] = -5.9822911525271882;
SS_A[0][5] = 1.3054877005159771;
SS_A[1][5] = 3.0428641316661391;
SS_A[2][5] = -3.8008195827078635;
SS_A[3][5] = 18.7056132912103760;
SS_A[4][5] = 45.6139800156876300;
SS_A[5][5] = -9.6488191765330686;
SS_A[6][5] = -8.8988800573680749;
SS_A[7][5] = 33.8752706538298870;
SS_A[8][5] = 13.6440354244059300;
SS_A[9][5] = -4.8024277109825579;
SS_A[10][5] = -8.6084974518616004;
SS_A[0][6] = -0.2848164568302304;
SS_A[1][6] = -0.3919113973996796;
SS_A[2][6] = 0.2602112904216472;
SS_A[3][6] = -4.8128950492014013;
SS_A[4][6] = 1.1289736424193868;
SS_A[5][6] = 9.2734859816968296;
SS_A[6][6] = -0.4518383751610383;
SS_A[7][6] = 30.0290617467313080;
SS_A[8][6] = 7.4377413351303900;
SS_A[9][6] = -0.4746477937714186;
SS_A[10][6] = -1.2529005089315504;
SS_A[0][7] = -5.5009576387443468;
SS_A[1][7] = 1.4571808725918822;
SS_A[2][7] = -7.6031201501270793;
SS_A[3][7] = 10.8710087035786900;
SS_A[4][7] = 6.9049847645602949;
SS_A[5][7] = 2.0593527119671426;
SS_A[6][7] = -29.0374587777634080;
SS_A[7][7] = -63.7198195809262840;
SS_A[8][7] = -61.9987225647258880;
SS_A[9][7] = 19.1897129543921530;
SS_A[10][7] = 30.5564313078274740;
SS_A[0][8] = -1.1941104596836096;
SS_A[1][8] = -2.7230469925224532;
SS_A[2][8] = 3.0457026513078609;
SS_A[3][8] = -22.4340328329416610;
SS_A[4][8] = -6.1703748397103269;
SS_A[5][8] = 14.9034386687599820;
SS_A[6][8] = -7.5758679094493013;
SS_A[7][8] = -5.8846673359291826;
SS_A[8][8] = -34.8514700485798840;
SS_A[9][8] = 27.9007646608998030;
SS_A[10][8] = 25.2626597121768270;
SS_A[0][9] = -0.5369263044627857;
SS_A[1][9] = -0.2845475994089419;
SS_A[2][9] = -0.1382491174469028;
SS_A[3][9] = -3.6044358136629171;
SS_A[4][9] = 0.8436412492201435;
SS_A[5][9] = 4.5963632398422929;
SS_A[6][9] = -1.0528493853824445;
SS_A[7][9] = -18.7246466901698870;
SS_A[8][9] = -29.0780824944977140;
SS_A[9][9] = -4.2596939198374573;
SS_A[10][9] = -18.9296770565978040;
SS_A[0][10] = -0.9238878899224057;
SS_A[1][10] = 1.9441131752328338;
SS_A[2][10] = -3.9692248656901281;
SS_A[3][10] = 14.1107597986667400;
SS_A[4][10] = 6.5526475348087443;
SS_A[5][10] = -4.3035304151523395;
SS_A[6][10] = 0.8375922650709887;
SS_A[7][10] = -18.3459636902182910;
SS_A[8][10] = 14.3540247895735290;
SS_A[9][10] = 4.2302216002999513;
SS_A[10][10] = -96.4776903020550240;

SS_B[0][0] = -0.5455996263288123;
SS_B[1][0] = -0.5518761163705884;
SS_B[2][0] = 0.5900071800457865;
SS_B[3][0] = 0.7190594121422225;
SS_B[4][0] = -0.0943237752273438;
SS_B[5][0] = -0.1134937972905044;
SS_B[6][0] = -0.0163070867703566;
SS_B[7][0] = 0.2058264531879017;
SS_B[8][0] = 0.1027611526633615;
SS_B[9][0] = -0.0247490154709102;
SS_B[10][0] = -0.0507681819165329;
SS_B[0][1] = 0.0043102922629641;
SS_B[1][1] = -0.0017278919440934;
SS_B[2][1] = -0.0003481999716615;
SS_B[3][1] = 0.0027122456480348;
SS_B[4][1] = -0.0010620761268567;
SS_B[5][1] = -0.0004842983655861;
SS_B[6][1] = 0.0034705248863926;
SS_B[7][1] = -0.0055268639088823;
SS_B[8][1] = -0.0147612726127354;
SS_B[9][1] = -0.0017441780401482;
SS_B[10][1] = -0.0080898332694241;
SS_B[0][2] = -0.0038969023082299;
SS_B[1][2] = 0.0146447837450380;
SS_B[2][2] = -0.0113651602912212;
SS_B[3][2] = -0.0193292417786368;
SS_B[4][2] = -0.0024664599556552;
SS_B[5][2] = 0.0023171325561123;
SS_B[6][2] = -0.0111099157936211;
SS_B[7][2] = 0.0194803452214108;
SS_B[8][2] = 0.0285237926675895;
SS_B[9][2] = 0.0090472374552359;
SS_B[10][2] = 0.0231403672235009;

SS_C[0][0] = 0.5130208321320656;
SS_C[1][0] = 0.1858018905061360;
SS_C[0][1] = -0.3674119284087852;
SS_C[1][1] = 0.4120596776981831;
SS_C[0][2] = 0.5267580226078330;
SS_C[1][2] = -0.2660145601946021;
SS_C[0][3] = -0.3843165173929192;
SS_C[1][3] = 0.6080528172071092;
SS_C[0][4] = -0.0885131426871652;
SS_C[1][4] = 0.0327048861057758;
SS_C[0][5] = -0.0073917004802315;
SS_C[1][5] = -0.1132775725182091;
SS_C[0][6] = 0.0047515221471859;
SS_C[1][6] = 0.0194632702326465;
SS_C[0][7] = 0.1806341461419177;
SS_C[1][7] = 0.1007266804481495;
SS_C[0][8] = 0.0081484377152340;
SS_C[1][8] = 0.1073543635666225;
SS_C[0][9] = 0.0134106199469380;
SS_C[1][9] = 0.0227500264181254;
SS_C[0][10] = 0.0478904651807054;
SS_C[1][10] = -0.0297461533219216;

SS_D[0][0] = 0.0000000000000000;
SS_D[1][0] = 0.0000000000000000;
SS_D[0][1] = 0.0000000000241534;
SS_D[1][1] = 0.0000000001414198;
SS_D[0][2] = -0.0000000000246369;
SS_D[1][2] = 0.0000000011013573;

/*END ASSEMBLY OF MATRICES */  
}

// Main get_control function
extern void get_ss_control(double* measurement, double* control_signal) {
	
	y[0][0] = measurement[0];		// q
	y[1][0] = measurement[1];		// az
	y[2][0] = measurement[2];		// accel

	
	// Output Calculation
	tmpCx = mat_mul(SS_C, x, tmpCx);
	tmpDy = mat_mul(SS_D, y, tmpDy);
	u = mat_add(tmpCx, tmpDy, u);
	
	// State Update
	tmpAx = mat_mul(SS_A, x, tmpAx);
	tmpBy = mat_mul(SS_B, y, tmpBy);
	x = mat_add(tmpAx, tmpBy, x);
	
	control_signal[0]   = u[0][0];	// L1R1 symmetric [rad]
	control_signal[1]   = u[1][0];	// L4R4 symmetric [rad]
	
}

extern void close_ss_control(void){
	//free memory space
	mat_free(SS_A);
	mat_free(SS_B);
	mat_free(SS_C);
	mat_free(SS_D);
	mat_free(tmpAx);
	mat_free(tmpBy);
	mat_free(tmpCx);
	mat_free(tmpDy);
	mat_free(x);
	mat_free(u);
	mat_free(y);
}


// Reset parameters to initial values
extern void reset_ss_control(void){
	x = mat_scalMul(x, 0.0, x);
}
